#!/bin/bash

ERROR() { echo "==> Error: $1" ; }
INFO()  { echo "==> Info: $1" ; }
Check() {
    if ! "$@" ; then
        ERROR "'$*' failed"
        exit 0
    fi
}

BashrcConfig() {
    [ -n "$new_user" ] || return

    cat <<EOF >> $home/.bashrc

# Aliases

alias AA='arch-audit'
alias branch='grep ^\[testing\]\$ $pacmanconf >/dev/null && echo testing || echo stable'
alias cp='cp -i'
#alias df='df -hT'
alias grep='grep -n'
alias hlp='eos-apps-info-helper'
alias inxi='inxi -z'
alias l='ls -la --file-type --ignore=.?*'
alias ll='ls -la --file-type --ignore=..'
alias ln='ln -i'
alias ls='ls --color=never -v --group-directories-first --time-style=long-iso'
alias md='vscodium -n'                     # Visual Studio Code as a markdown editor
alias mv='mv -i'
alias nano='nano -l'
alias ncdu='ncdu --slow-ui-updates --disable-shell --color off'
alias pacdiff=eos-pacdiff
alias poweroff='sync; poweroff'
alias PP='pac -Syu'
alias reboot='sync; reboot'
alias rm='rm -i'
alias sou='source ~/.bashrc'               # re-read ~/.bashrc
alias update-grub='sudo grub-mkconfig -o /boot/grub/grub.cfg'


# Key bindings and features

bind '"\e[A":history-search-backward'      # history with arrow up key
bind '"\e[B":history-search-forward'       # history with arrow down key
bind 'set show-all-if-ambiguous on'        # complete with single TAB
bind 'set mark-symlinked-directories on'   # complete directory symlinks with slash

# Variables

export SyncAfterUpdate=yes                 # see also: /etc/eos-update-notifier.conf
export LESS="-RFn"
export FUNCNEST=50
export DIFFPROG=meld
export HISTCONTROL="erasedups"
PS1='\w> '

# Functions

_fork_run() { setsid /usr/bin/"\${FUNCNAME[1]}" "\$@" >& /dev/null ; }
_sync_run() { /usr/bin/"\${FUNCNAME[1]}" "\$@" ; sync ; }

df() { /usr/bin/df -hT "\$@" | awk '{print \$1,\$2,\$3,\$5,\$6,\$7,\$8,\$9}' | column -t -R3,4,5 ; }

emacs()                     { _fork_run --reverse-video "\$@" ; }
firefox-developer-edition() { _fork_run "\$@" ; }
firefox()                   { _fork_run "\$@" ; }
gitk()                      { _fork_run "\$@" ; }
librewolf()                 { _fork_run "\$@" ; }
vivaldi-stable()            { _fork_run "\$@" ; }

paru()  { _sync_run "\$@" ; }
yay()   { _sync_run "\$@" ; }

curl() {
    local code=0
    command curl --fail "\$@"
    code=\$?
    if [ \$code -ne 0 ] ; then
        curl-exit-code-to-string \$code
    fi
    return \$code
}

type() {
    # without parameters, show all aliases and functions
    case "\$1" in
        "") { alias && declare -F ; } | less ;;
        *) builtin type -a "\$@" ;;
    esac
}

meld() {
    # Adding support for 'meld' with
    # - git and hub
    # - comparing two files when one of the args is a folder name
    local meld="setsid /usr/bin/meld"
    local xx
    local parents="\$PWD"
    local has_git=no

    # Is this a git tree?

    while [ -n "\$parents" ] ; do
        if [ -d "\$parents/.git" ] ; then
            has_git=yes
            break
        fi
        [ "\$parents" = "/" ] && break
        parents="\$(dirname "\$parents")"
    done

    if [ "\$has_git" = "yes" ] ; then
        if [ -z "\$1" ] ; then
            # meld for the current folder in git tree
            \$meld .
            return
        fi
    fi

    # compare two files/folders

    if [ -n "\$1" ] && [ -n "\$2" ] && [ -z "\$3" ] && [ -e "\$1" ] && [ -e "\$2" ] ; then
        # Two args, files or folders.
        # If one of them is a folder, meld needs help to use the file in the folder.
        local f1="\$1"
        local f2="\$2"
        if [ -d "\$f1" ] && [ ! -d "\$f2" ] ; then
            f1="\${f1%/}"                             # remove possible trailing slash
            f1="\$f1/\$(basename "\$f2")"               # add file name after the folder name
        elif [ -d "\$f2" ] && [ ! -d "\$f1" ] ; then
            f2="\${f2%/}"
            f2="\$f2/\$(basename "\$f1")"
        fi
        \$meld "\$f1" "\$f2"
    else
        # Other cases
        \$meld "\$@"
    fi
}

paccache() {
    # 1. check if sudo is needed
    # 2. be verbose always

    local sudo=no
    local verbose=0
    local arg

    for arg in "\$@" ; do
        case "\$arg" in
            --move | --remove) sudo=yes ;;
            --verbose) ((verbose++)) ;;
            --*) ;;
            -*m* | -*r*) sudo=yes ;;
            -*v*) ((verbose++)) ;;
        esac
    done
    if [ \$verbose -eq 0 ] ; then
        verbose="--verbose"
    else
        verbose=""
    fi
    if [ "\$sudo" = "yes" ] ; then
        sudo /usr/bin/paccache \$verbose "\$@"
    else
        /usr/bin/paccache \$verbose "\$@"
    fi
}

_set_terminal_window_title()  { printf "\e]0;%s\a" "\$*" ; }

MyTermTitle() {
    if [ -z "\$_CURRENT_KERNEL" ] ; then
        _CURRENT_KERNEL=\$(cat /proc/cmdline | sed 's|^BOOT_IMAGE=.*vmlinuz-\([^ ]*\) .*|\1|')
    fi
    local latest_command="\$(history 1 | sed 's|^[ ]*[0-9]*[ ]*||')"
    [ "\$latest_command" = "\$_latest_command_previous" ] && return
    latest_command="\$_CURRENT_KERNEL: \$latest_command"
    _latest_command_previous="\$latest_command"
    _set_terminal_window_title "\$latest_command"
}

# Set terminal title to the currently running terminal:
trap "MyTermTitle" DEBUG

EOF
    chown $new_user:$new_user $home/.bashrc    # not really needed if it already exists
}

EmacsConfig() {
    [ -n "$new_user" ] || return
    [ -x /usr/bin/emacs ] || return

    cat <<EOF > $home/.emacs
(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 '(c-guess-guessed-basic-offset 2 t)
 '(column-number-mode t)
 '(cua-mode t nil (cua-base))
 '(gdb-many-windows t)
 '(global-display-line-numbers-mode t)
 '(indent-tabs-mode nil)
 '(inhibit-startup-screen t)
 '(make-backup-files nil)
 '(next-line-add-newlines nil)
 '(package-selected-packages '(realgud))
 '(require-final-newline t)
 '(scroll-step 1)
 '(select-enable-clipboard t)
 '(tool-bar-mode nil)
 '(tool-bar-position 'right)
 '(vc-follow-symlinks t)
 '(x-select-enable-clipboard-manager nil))
EOF
    chown $new_user:$new_user $home/.emacs
}

GetNewUserName() {
    INFO "$FUNCNAME started."
    if [ -z "$new_user" ] ; then
        if [ -r /tmp/new_username.txt ] ; then
            new_user=$(cat /tmp/new_username.txt)
        else
            ERROR "new username not found. You can use command: $0 'your-username'"
        fi
    else
        echo "new_user already set to '$new_user'"
    fi
    INFO "$FUNCNAME done."
}

OtherConfig() {
    local file="$home/.config/autostart/Terminal-at-start.desktop"

    cat <<EOF > "$file"
[Desktop Entry]
Encoding=UTF-8
Version=0.9.4
Type=Application
Name=Terminal at start
Comment=
Exec=xfce4-terminal
OnlyShowIn=XFCE;
RunHook=0
StartupNotify=false
Terminal=false
Hidden=false
EOF
    chown "$new_user:$new_user" "$file"

    case "$this_rig" in
        l1)
            file="$home/.config/autostart/Xbacklight.desktop"
            cat <<EOF > "$file"
[Desktop Entry]
Version=1.0
Type=Application
Name=Xbacklight
Comment=
Exec=xbacklight =30
Icon=
Path=
Terminal=false
StartupNotify=false
EOF
            chown "$new_user:$new_user" "$file"
            ;;
    esac
}

HomeSettings() {
    INFO "$FUNCNAME started."
    # Add here some user specific stuff!
    if [ -n "$new_user" ] && [ -d $home ] ; then
        EmacsConfig
        BashrcConfig
        OtherConfig
    else
        ERROR "$FUNCNAME failed!"
    fi  
    INFO "$FUNCNAME done."
}

InstallPackages() {
    INFO "$FUNCNAME started."
    local Install=(   # packages to install
        akm
        atril
        emacs
        firefox-developer-edition
        gparted
        # kaffeine
        libreoffice-fresh
        libreoffice-fresh-fi
        linux-lts
        linux-lts-headers
        llpp            # fast PDF reader for complex PDF files
        most
        mpv
        ncdu
        pahis
        paru
        # rcs
        simple-scan
        solaar
        terminator
        vscodium-bin

        # m-m
        m-common
        pac
    )
    #if ! pacman -Q firewalld >& /dev/null ; then
        Install+=(gufw)
    #fi
    Check pacman -Sy
    Check pacman -S --noconfirm --needed "${Install[@]}"
    INFO "$FUNCNAME done."
}

RemovePackages() {
    INFO "$FUNCNAME started."
    Remove=(    # packages to remove
        file-roller
        glances
        parole
        power-profiles-daemon
        xfce4-netload-plugin
        xfce4-weather-plugin
    )
    local remove=()
    local pkg

    case "$this_rig" in
        v1 | p1) Remove+=(bluez) ;;
    esac

    for pkg in "${Remove[@]}" ; do
        if pacman -Q $pkg >& /dev/null ; then
            remove+=($pkg)
        fi
    done
    if [ ${#remove[0]} -gt 0 ] ; then
        INFO "Removing packages: ${remove[*]}"
        Check pacman -Rsn --noconfirm "${remove[@]}"
    fi
    INFO "$FUNCNAME done."
}

AddRepos() {
    INFO "$FUNCNAME started."
    local reponames=(
        m-m
        m-aur
        m-more2
    )
    local mirrorlist_pkg="mirrorlist-m"
    local mirrorlist_file="mirrorlist-m"
    local mirrorlist_file_url="https://github.com/manuel-192/m-m/raw/master/PKGBUILDs/$mirrorlist_pkg/$mirrorlist_file"
    local repo_gpg_key="A1F1B5187D25904B"
    local siglevel=Required

    Setup3rdPartyRepos "$mirrorlist_pkg" \
                       "$mirrorlist_file" \
                       "$mirrorlist_file_url" \
                       "$repo_gpg_key" \
                       "$siglevel" \
                       "${reponames[@]}"
    INFO "$FUNCNAME done."
}

Setup3rdPartyRepos() {
    local mirrorlist_pkg="$1"
    local mirrorlist_file="$2"
    local mirrorlist_file_url="$3"
    local repo_gpg_key="$4"
    local siglevel="$5"

    shift 5

    # tail is repo name(s), must have at least 1
    [ -n "$1" ] || Check false

    local reponame
    local repo_added=no
    local key_added="$(pacman-key --list-keys 2>/dev/null | grep -w "$repo_gpg_key")"
    local need_mirrorlist_pkg=no

    if [ -z "$key_added" ] ; then
        Check pacman-key --keyserver hkps://keyserver.ubuntu.com --recv-keys "$repo_gpg_key"
        INFO "pacman-key: key received"
        Check pacman-key --lsign-key "$repo_gpg_key"
        INFO "pacman-key: key signed"
    fi

    if ! pacman -Q "$mirrorlist_pkg" >& /dev/null  ; then
        Check wget -O "/etc/pacman.d/$mirrorlist_file" "$mirrorlist_file_url"
        INFO "File $mirrorlist_file fetched"
        need_mirrorlist_pkg=yes
    fi

    for reponame in "$@" ; do
        if [ -z "$(grep "^\[$reponame\]$" $pacmanconf )" ] ; then
            cat <<EOF >> "$pacmanconf"

[$reponame]
Include = /etc/pacman.d/$mirrorlist_file
EOF
            [ -n "$siglevel" ] && echo "SigLevel = $siglevel" >> "$pacmanconf"
            repo_added=yes
            INFO "Repository [$reponame] was added to $pacmanconf."
        else
            INFO "[$reponame] is already set up in $pacmanconf."
        fi
    done
    if [ "$repo_added" = "yes" ] ; then
        Check pacman -Sy
    fi
    if [ "$need_mirrorlist_pkg" = "yes" ] ; then
        Check pacman --overwrite "/etc/pacman.d/$mirrorlist_file" -Sy --noconfirm "$mirrorlist_pkg"
    fi
}

GrubDefaultEntry() {
    local entry="EndeavourOS, on linux"
    sed -i /etc/default/grub -e "s|^\(GRUB_DEFAULT=\)0$|\1'$entry'|"
    update_grub=yes
}

Blacklist() {
    local blacklists="$1"

    sed -i /etc/default/grub \
        -e "s|^\(GRUB_CMDLINE_LINUX_DEFAULT=\"\)|\1module_blacklist=$blacklists |"
    update_grub=yes
}

ThisRig() {
    INFO "$FUNCNAME started."
    if [ -n "$(echo "$graphics" | grep "8086:0046")" ] && [ -n "$(echo "$graphics" | grep "10de:0a2b")" ] ; then
        this_rig=l1   # vanha
    elif [ -n "$(echo "$graphics" | grep "8086:5917")" ] && [ -n "$(echo "$graphics" | grep "1002:6660")" ] ; then
        this_rig=l2   # uudempi
    elif [ -n "$(echo "$graphics" | grep "10de:1d01")" ] ; then
        this_rig=p1
    elif [ -n "$(echo "$graphics" | grep "15ad:0405")" ] ; then
        this_rig=v1
    fi
    INFO "$FUNCNAME done."
}

DriverSettings() {
    INFO "$FUNCNAME started."
    case "$this_rig" in
        l1) Blacklist nouveau
            GrubDefaultEntry
            Check pacman -S --needed --noconfirm xf86-video-intel xorg-xbacklight
            ;;
        l2) Blacklist radeon,amdgpu
            GrubDefaultEntry
            Check pacman -S --needed --noconfirm xf86-video-intel xorg-xbacklight
            ;;
        p1) Blacklist nouveau,i915
            GrubDefaultEntry
            ;;
        v1) GrubDefaultEntry
            ;;
    esac
    INFO "$FUNCNAME done."
}

SystemSettings() {
    sed -i /etc/eos-script-lib-yad.conf \
        -e 's|^\(EOS_PACDIFF_WARNING\)=.*|\1=no|' \
        -e 's|^\(SyncAfterUpdate\)=.*|\1=yes|'
}

SetRepoTypes() {
    case "$repotype" in
        testing)
            sed -i $pacmanconf \
                -e 's|^#\(\[testing\]\)$|\1|' \
                -e 's|^#\(\[community-testing\]\)$|\1|' \
                -e 's|^#\(\[multilib-testing\]\)$|\1|' \
                -e 's|^#\(Include = \)$|\1|'
            ;;
    esac
}

Lspci() {
    INFO "$FUNCNAME started."
    lspci=$(lspci -vnn)
    graphics=$(echo "$lspci" | grep -Pw 'VGA|Display|3D')
    INFO "$FUNCNAME done."
}

Services() {
    INFO "$FUNCNAME started."
    local xx

    sleep 1

    # enable ufw firewall service
    for xx in ufw ; do
        if pacman -Q $xx >& /dev/null ; then
            systemctl enable $xx
        fi
    done
    INFO "$FUNCNAME done."
}

GrubSettings() {
    INFO "$FUNCNAME started."
    cat <<EOF >> /boot/grub/custom.cfg

menuentry 'Shutdown' { halt ; }
menuentry 'Restart'  { reboot ; }
EOF
    update_grub=yes

    if [ "$update_grub" = "yes" ] ; then
        grub-mkconfig -o /boot/grub/grub.cfg
    fi
    INFO "$FUNCNAME done."
}

Main() {
    local new_user="$1"
    GetNewUserName
    local home="/home/$new_user"
    local update_grub=no
    local lspci=""
    local graphics=""
    local this_rig=""
    local pacmanconf=/etc/pacman.conf
    local repotype=stable    # stable or testing

    Lspci

    SetRepoTypes

    ThisRig

    AddRepos

    RemovePackages
    InstallPackages
    Services

    DriverSettings
    SystemSettings

    HomeSettings    # modify some dotfiles at $HOME

    GrubSettings

    rm -f /etc/pacman.d/mirrorlist.pacnew
}

Main "$@"
